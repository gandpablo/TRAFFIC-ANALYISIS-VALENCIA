---
title: "Resumen_Mapa"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    number_sections: true
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, echo = TRUE)
```

```{r message=FALSE, warning=FALSE}
library(readr)
library(jsonlite)
library(dplyr)
library(leaflet)
library(purrr)
library(sf)
library(lubridate)
library(tibble)
```

# Carga de datos preliminar

## Datos Mensuales:

Datos mensuales de 2023 proporcionados por la empresa ETRA
Ejemplo de base de datos descargada.

Idpm: Identificador
Nombre: Nombre de la espira de trafico
Intensidad: Cantidad de coches que pasan por la espira (en principio)
Ocupacion: % del tiempo que la espira permanece ocupada (con un coche encima)
Velocidad: Velocidad media del intervalos de tiempo 
Fiabilidades de las variables: % de que sea correcto

El resto las ignoramos

```{r message=FALSE, warning=FALSE}
marzo <- read_delim("/Users/pablogandia/Library/CloudStorage/OneDrive-UPV/Archivos de Sergio Ortiz Montesinos - tráfico_data/2023/2023-03.csv", delim = ";", locale = locale(encoding = "LATIN1"),show_col_types = FALSE)

head(marzo)
```

## Base IDPM

Esta base obtenida con scrapping del open data de valencia.
Al exportar solo se descargan una pocos y hay que hacer scrapping con python sobre la tabla.

Las variables que nos interesan son el idpm (se conecta con los datos de trafico) y las coordenadas (geo_point_2d)

```{r message=FALSE, warning=FALSE}
ubis <- read_delim("/Users/pablogandia/Downloads/idpm_trafico.csv",delim=';')
head(ubis)
```

## Optimizar y filtrar datos importantes

### Zonas trafico y codigo postal mapa:
  
Por simplicidad el proceso de ver que zonas estaban en todas las bases de datos, así como corregir errores y añadir coordenadas manualmente a los idpm que no aparecian en esta base de datos lo hemos hecho en Python:

El notebook es filtrar_coordenadas.ipynb

El resultado es una base de datos con todas las idpm utiles que utilizaremos en el analisis, estas zonas son:

```{r message=FALSE, warning=FALSE}
ubis <- read_csv('/Users/pablogandia/Desktop/zonas_bien.csv')
head(ubis)
nrow(ubis)
```

En total tenemos tenemos 1129 zonas.
Antes habían unas 1400 pero algunas eran carriles bici.
  
Estas zonas se pueden ver aqui:
  
```{r message=FALSE, warning=FALSE}
postales <- fromJSON("/Users/pablogandia/Desktop/BASES TRAFICO/coordenadas.json")

añadir_leyenda <- function(mapa) {
  mapa %>% addLegend(
    position = "bottomright",
    colors = c("#dfeef7", "blue"),
    labels = c("Zonas postales", "Estaciones de tráfico"),
    title = "Elementos del mapa",
    opacity = 0.7
  )
}

crear_poligono <- function(cp, coords) {
  df <- as.data.frame(coords)
  df$lat <- as.numeric(df$lat)
  df$log <- as.numeric(df$log)

  if (nrow(df) < 3) return(NULL)

  if (!(df[1, "lat"] == df[nrow(df), "lat"] &&
        df[1, "log"] == df[nrow(df), "log"])) {
    df <- rbind(df, df[1, ])
  }
  
  poligono <- st_polygon(list(as.matrix(df[, c("log", "lat")])))
  st_sf(postal = cp, geometry = st_sfc(poligono, crs = 4326))
}

zonas_sf <- map2(names(postales), postales, crear_poligono) %>%
  compact() %>%
  bind_rows()

mean_lat <- mean(ubis$Lat, na.rm = TRUE)
mean_lon <- mean(ubis$Lon, na.rm = TRUE)

m <- leaflet() %>%
  addTiles() %>%
  setView(lng = mean_lon, lat = mean_lat, zoom = 11)


m <- m%>%
    addPolygons(data = zonas_sf,
              fillColor = "#dfeef7",
              color = "#8b0000",
              weight = 2,
              fillOpacity = 0.4,
              label = ~postal) 
m <- m %>%
  addCircleMarkers(data = ubis,
                   lng = ~Lon, lat = ~Lat,
                   radius = 4, color = "blue", fillOpacity = 0.6,
                   popup = ~as.character(nombre))



m <- añadir_leyenda(m)
m
```
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
  
